{% extends "base.html" %}
{% block title %}Carrinho e Pagamento{% endblock %}

{% block content %}
    
    {% if not carrinho or carrinho.calcular_total() == 0 %}
        {% else %}
        <h2 style="margin-bottom: 5px;">Fechamento do Pedido</h2>
        <p>Cliente Associado: <strong>{{ carrinho.cliente.nome }}</strong> (Associação)</p>
        
        <form method="POST" action="{{ url_for('limpar_carrinho') }}" style="float: right; margin-top: -50px;">
            <button type="submit" class="btn" style="background-color: #f7a000; padding: 8px 15px;">Limpar Carrinho</button>
        </form>
        
        <h4 style="margin-top: 30px; border-bottom: 1px solid #eee; padding-bottom: 10px;">Itens Escolhidos (Composição):</h4>
        
        <table style="width: 100%; margin-bottom: 30px;">
            <thead>
                <tr>
                    <th>Produto</th>
                    <th>Preço Unitário</th>
                    <th>Quantidade</th>
                    <th>Subtotal (R$)</th>
                </tr>
            </thead>
            <tbody>
                {% for item in carrinho.itens %}
                <tr>
                    <td>{{ item.produto.nome }}</td>
                    <td>R$ {{ "%.2f"|format(item.produto.preco) }}</td>
                    <td>{{ item.quantidade }}</td>
                    <td>R$ {{ "%.2f"|format(item.calcular_subtotal()) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <h3 style="margin-top: 40px;">Total a Pagar: <span style="color: var(--primary-color);">R$ {{ "%.2f"|format(carrinho.calcular_total()) }}</span></h3>
        
        <h3 style="margin-top: 40px;">Escolha a Forma de Pagamento (POLIMORFISMO):</h3>

        <form method="POST" action="{{ url_for('checkout_web') }}">
            
            <div class="form-group" style="padding: 15px; border: 1px solid #007bff; border-radius: 5px; margin-bottom: 15px;">
                <label>
                    <input type="radio" name="pagamento" value="pix" required> 
                    **PIX** - Pagamento Imediato (R$ {{ "%.2f"|format(carrinho.calcular_total()) }})
                </label>
                <p style="margin-left: 25px; font-size: 0.9em; color: #007bff;">*O QR Code será exibido na tela de confirmação (Teste de Geração de Serviço).*</p>
            </div>
            
            <div class="form-group" style="padding: 15px; border: 1px solid #007bff; border-radius: 5px; margin-bottom: 15px;">
                <label>
                    <input type="radio" name="pagamento" value="cartao" required> 
                    **CARTÃO DE CRÉDITO**
                </label>
                
                <div style="margin-left: 25px; margin-top: 10px;">
                    <label for="parcelas">Parcelar em:</label>
                    <select name="parcelas" id="parcelas" style="padding: 5px; border-radius: 4px;">
                        {% for i in range(1, 13) %}
                            <option value="{{ i }}">
                                {{ i }}x de R$ {{ "%.2f"|format((carrinho.calcular_total() * (1 + (0.02 if i > 3 else 0))) / i) }} 
                                {% if i > 3 %} (2% de taxa) {% else %} (Sem juros) {% endif %}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div class="form-group" style="padding: 15px; border: 1px solid #007bff; border-radius: 5px; margin-bottom: 15px;">
                <label>
                    <input type="radio" name="pagamento" value="boleto" required> 
                    **BOLETO** - Compensação em D+1
                </label>
            </div>

            <button type="submit" class="btn success" style="padding: 15px 30px; font-size: 1.1em; margin-top: 20px;">CONFIRMAR PAGAMENTO</button>
        </form>
    {% endif %}

{% endblock %}